import { render } from '@react-email/render';
import * as React from 'react';
import * as EmailComponents from '../../emails/components';

export interface ComponentTree {
  subject: string;
  previewText: string;
  components: Array<{
    type: string;
    props: Record<string, unknown>;
  }>;
}

/**
 * Render email from component tree generated by LLM agents
 * Maps component type strings to React Email components
 */
export async function renderEmailFromTree(tree: ComponentTree): Promise<string> {
  const {
    EmailShell,
    EmailContainer,
    EmailHeader,
    EmailFooter,
    EmailSection,
    ValidationBlock,
    ScoreCard,
    PressureZoneCard,
    InterventionCard,
    TipCallout,
    ResourceList,
    CTAButton,
  } = EmailComponents;

  // Component type map
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const componentMap: Record<string, React.ComponentType<any>> = {
    EmailSection,
    ValidationBlock,
    ScoreCard,
    PressureZoneCard,
    InterventionCard,
    TipCallout,
    ResourceList,
    CTAButton,
  };

  // Map component tree to React elements
  const contentElements = tree.components.map((comp, idx) => {
    const Component = componentMap[comp.type];
    if (!Component) {
      console.warn(`Unknown component type: ${comp.type}, skipping`);
      return null;
    }
    return React.createElement(Component, { key: idx, ...comp.props });
  }).filter(Boolean);

  // Wrap in email shell
  const containerChildren = [
    React.createElement(EmailHeader, {}),
    ...contentElements,
    React.createElement(EmailFooter, {})
  ];

  const email = React.createElement(
    EmailShell,
    { previewText: tree.previewText, children: React.createElement(
      EmailContainer,
      { children: containerChildren }
    ) }
  );

  // Render to HTML
  return await render(email);
}
